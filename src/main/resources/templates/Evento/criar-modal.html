<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-br">
<body>

<div th:fragment="modal-evento">
    <div class="modal fade" id="modalEvento" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">

                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title fw-bold text-white">
                        <i class="bi bi-calendar-plus-fill me-2"></i> Criar Novo Evento
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-4">
                    <form id="formCriarEvento">

                        <div class="mb-3">
                            <label for="nomeEvento" class="form-label fw-bold">Nome do Evento</label>
                            <input type="text" class="form-control" id="nomeEvento" name="nome" placeholder="Ex: Workshop de Java" required>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="categoriaEvento" class="form-label">Categoria</label>
                                <select class="form-select" id="categoriaEvento" name="categoria" required>
                                    <option selected disabled value="">Selecione...</option>
                                    <option value="01">ğŸµ MÃºsica</option>
                                    <option value="02">ğŸ’» Tecnologia</option>
                                    <option value="03">ğŸ­ Cultura</option>
                                    <option value="04">âš½ Esportes</option>
                                    <option value="05">ğŸŒ Online</option>
                                    <option value="06">ğŸ“š EducaÃ§Ã£o</option>
                                    <option value="07">ğŸ” Gastronomia</option>
                                    <option value="08">ğŸŒ Viagens</option>
                                    <option value="09">ğŸ® Games</option>
                                    <option value="10">ğŸ¨ Arte</option>
                                    <option value="11">ğŸ¾ Pets</option>
                                    <option value="12">ğŸ’¼ NegÃ³cios</option>
                                    <option value="13">ğŸ’¡ InovaÃ§Ã£o</option>
                                    <option value="14">ğŸ¥ SaÃºde</option>
                                    <option value="15">ğŸ¡ DecoraÃ§Ã£o</option>
                                    <option value="16">ğŸ“· Fotografia</option>
                                    <option value="17">ğŸ‰ Outros</option>
                                    <option value="18">ğŸŒ± Meio Ambiente</option>
                                    <option value="19">ğŸš— AutomÃ³veis</option>
                                    <option value="20">ğŸ§˜ Bem-estar</option>
                                    <option value="21">ğŸ¬ Filmes e SÃ©ries</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="dataEvento" class="form-label">Data e Hora</label>
                                <input type="datetime-local" class="form-control" id="dataEvento" name="dataHora" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="localEvento" class="form-label">Local / EndereÃ§o</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                                <input type="text" class="form-control" id="localEvento" name="local" placeholder="Ex: Av. Paulista, 1000 ou Online">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="descricaoEvento" class="form-label">DescriÃ§Ã£o</label>
                            <textarea class="form-control" id="descricaoEvento" name="descricao" rows="3" placeholder="Conte mais sobre o evento..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="imgEvento" class="form-label">URL da Imagem (Capa)</label>
                            <input type="url" class="form-control" id="imgEvento" name="urlImagem" placeholder="http://...">
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="button" id="btnPublicarEvento" class="btn btn-primary btn-lg fw-bold" style="background: #667eea; border: none;">
                                Publicar Evento
                            </button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT SIMPLIFICADO -->
    <script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('formCriarEvento');
        const btnPublicar = document.getElementById('btnPublicarEvento');
        const modalElement = document.getElementById('modalEvento');
        const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);

        btnPublicar.addEventListener('click', function(event) {
            event.preventDefault();

            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const eventoData = {
                nomeEvento: document.getElementById('nomeEvento').value,
                descricaoDetalhada: document.getElementById('descricaoEvento').value,
                dataHoraInicio: document.getElementById('dataEvento').value,
                urlImagemDestaque: document.getElementById('imgEvento').value,
                gratuito: true,
                valorIngresso: 0.0,
                categoria: {
                    id: document.getElementById('categoriaEvento').value
                },
                local: {
                    id: 1 // Assumindo ID 1 para o local
                }
                // O campo 'usuarioCriador' foi removido daqui. O backend cuidarÃ¡ disso.
            };

            console.log('Enviando dados do evento (sem criador):', JSON.stringify(eventoData, null, 2));

            fetch('/eventos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(eventoData)
            })
            .then(response => {
                if (response.status === 401) {
                    throw new Error('Acesso nÃ£o autorizado. FaÃ§a o login para criar um evento.');
                }
                if (response.ok) {
                    return response.json();
                }
                return response.text().then(text => { throw new Error('Falha ao criar evento: ' + text) });
            })
            .then(data => {
                console.log('Evento criado com sucesso:', data);
                alert('Evento publicado com sucesso!');
                modal.hide();
                form.reset();
                window.location.reload();
            })
            .catch(error => {
                console.error('Erro:', error);
                alert(error.message);
            });
        });
    });
    /*]]>*/
    </script>
</div>

</body>
</html>